<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fantasy LEC</title>
    <link type="text/css"
          rel="stylesheet"
          href="LEC_stiler.css">
    <link rel="icon" href="bilder/leclogotransparent.png">
  <script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCD3UFf10gPrGUW6w3gt-z9kt8Iq_4rOPw",
      authDomain: "fantasy-lec.firebaseapp.com",
      databaseURL: "https://fantasy-lec.firebaseio.com",
      projectId: "fantasy-lec",
      storageBucket: "",
      messagingSenderId: "34381750647"
    };
    firebase.initializeApp(config);
  </script>
</head>
<body>
<div id="login">
  <!-- Dette elementet skal være det eneste man ser før man logger inn. Her logger man inn, eller oppretter en bruker. Etter å ha logget inn, forsvinner dette elementet, og hovednettsiden vises -->
  <img src="bilder/leclogo-mono.jpg">
  <form id="loginForm" onsubmit="LogIn(event)">
    <h1>Logg in</h1>
    <input type="text" required id="LogInBrukernavn" placeholder="Brukernavn">
    <input type="password" required id="LogInPassord" placeholder="Passord">
    <button type="submit">Logg inn</button>
  </form>
  <form id="registrerForm" onsubmit="registrerBruker(event)">
    <h1>Registrer bruker</h1>
    <input type="text" required id="registrerBrukernavn" placeholder="Brukernavn">
    <input type="password" required id="registrerPassord" placeholder="Passord">
    <button type="submit">Opprett bruker</button>
  </form>
</div>
<header>
</header>
<main>
  <div class="gradient"></div>
  <div class="innhold">
  <section id="tittel">
    <img src="bilder/leclogotransparent.png">
    <h1 id="title">LEC</h1>
  </section>
  <section id="lag">

  </section>
  <!-- Denne seksjonen kan bare brukeren som er admin se -->
  <section id="admin">
    <h2>Sett opp en kamp:</h2>
    <form id="matchregistration" onsubmit="registrerMatch(event)">
      <label>Lag 1:<select id="adminInpLag1">
        <option value="TBD">TBD</option>
      </select></label>
      <label>Lag 2:<select id="adminInpLag2">
        <option value="TBD">TBD</option>
      </select></label>
      <label>Kamp:<select id="kampnummerregistrer">
        <option value="Runde1Kamp1">Runde 1 Kamp 1</option>
        <option value="Runde1Kamp2">Runde 1 Kamp 2</option>
        <option value="Runde2Kamp1">Runde 2 Kamp 1</option>
        <option value="Runde2Kamp2">Runde 2 Kamp 2</option>
        <option value="Semifinale">Semifinale</option>
        <option value="Finale">Finale</option>
      </select></label>
      <button type="submit">Send inn</button>
    </form>
    <h2>Legg inn resultater</h2>
  </section>
  <section id="kampListe">
    <h2>Gjett kampresultater:</h2>
  </section>
  <section id="leaderboard">
    <button onclick="regnUtPoeng()">Regn ut poeng</button>
    <table>
      <thead>
        <th>Poeng</th>
        <th>Bruker</th>
      </thead>
      <tbody>

      </tbody>
    </table>
  </section>
  <section id="historie">

  </section>
</div>
  <div class="gradient"></div>
</main>
<footer>
  <p>Laget og administrert av Marius Berdal Gaalaas</p>
</footer>
<script>
  let database = firebase.database();
  let brukere = database.ref("brukere");
  let LoggetPåBruker;
  let LoggetPåBrukerKey
  let lag = database.ref("lag");
  let kamper = database.ref("kamper");
  let admindel = document.querySelector("#admin");
  let gjett = database.ref("gjett");
  let brukerObj;
  let kampObj;

  // Funksjoner
  //Registrer en bruker og legger det til i en database
  function registrerBruker(event){
    event.preventDefault();
    let brukernavnRegistrer = document.querySelector("#registrerBrukernavn");
    let passordRegistrer = document.querySelector("#registrerPassord");
    let registrerSkjema = document.querySelector("#registrerForm");
    brukere.push({
      "brukernavn":brukernavnRegistrer.value,
      "passord":passordRegistrer.value,
      "admin":false,
      "poeng":0
    });
    registrerSkjema.reset();
  }
  //De to neste funksjonene logger deg inn, og ordner slik at login siden forsvinner og resten kommer til syne
  function LogIn(event){
    event.preventDefault();
    brukere.on("child_added", hentBrukereLogIn);
  }
  function hentBrukereLogIn(snapshotLogIn){
    let brukernavn = document.querySelector("#LogInBrukernavn");
    let passord = document.querySelector("#LogInPassord");
    let bruker = snapshotLogIn.val();
    let brukerKey = snapshotLogIn.key;
    if (brukernavn.value ==bruker.brukernavn && passord.value==bruker.passord){
      let loginscreen = document.querySelector("#login");
      let header = document.querySelector("header");
      let main = document.querySelector("main");
      let footer = document.querySelector("footer");

      loginscreen.style.display = "none";
      header.style.display = "block";
      main.style.display = "grid";
      footer.style.display = "block";

      LoggetPåBruker = snapshotLogIn.val();
      LoggetPåBrukerKey = snapshotLogIn.key;

      if (bruker.admin){
        admindel.style.display = "block";
      }

      header.innerHTML += `
      <p>${brukernavn.value}</p><p>${-bruker.poeng} poeng</p><button onclick="location.reload()">Logg ut</button>
      `;
    }
  }
  //Henter lagenes logo til delen under overskriften, og legger til alle lagene som valgmuligheter i select-elementet der adminen legger til en kamp
  function hentLag(snapshotLag){
    let lagdel = document.querySelector("#lag");
    let lagKey = snapshotLag.key;
    let lag = snapshotLag.val();
    lagdel.innerHTML += `
    <a href=${lag.link}><img src=${lag.logo} title=${lag.navn}></a>
    `;
    let adminLag1 = document.querySelector("#adminInpLag1");
    let adminLag2 = document.querySelector("#adminInpLag2");
    adminLag1.innerHTML +=`
    <option value="${lagKey}">${lag.navn}</option>
    `;
    adminLag2.innerHTML +=`
    <option value="${lagKey}">${lag.navn}</option>
    `;
  }
  //Pusher kampen som adminen har lagt inn, til databasen
  function registrerMatch(event){
    event.preventDefault();
    let regiLag1 = document.querySelector("#adminInpLag1");
    let regiLag2 = document.querySelector("#adminInpLag2");
    let regiKamp = document.querySelector("#kampnummerregistrer");
    let kampKey = regiKamp.value;
    let kampData = {
      "lag1": regiLag1.value,
      "lag2": regiLag2.value,
      "kampNR":regiKamp.value,
      "lag1resultat": "TBD",
      "lag2resultat": "TBD",
      "vinner": "TBD"
    };
    let kamp = kamper.child(kampKey);
    kamp.set(kampData);
  }
  //Setter opp poenglisten. Siden Firebase bare sorterer i stigende rekkefølge, får man minuspoeng for å gjette riktig, men på nettsiden fjerner vi fortegnet, slik at en med -5 poeng i databasen har 5 poegn på nettsiden
  function Leaderboard(snapshotBrukere){
    let brukerL = snapshotBrukere.val();
    let tabell = document.querySelector("tbody");
    tabell.innerHTML += `
    <tr>
      <td>${-brukerL.poeng}</td>
      <td>${brukerL.brukernavn}</td>
    </tr>
    `;
  }
  //Når adminen har lagt inn en kamp, lages et element som er tilgjengelig for alle. Dette viser hvem som spiller kampen og lar brukeren gjette vinneren og stillingen. Hver kamp er best av 5, så det er unødvendig med verdier høyere enn 3 når man skal gjette stillingen. Derfor har jeg brukt select istedet for input type="number". I tillegg lages et element som bare admin kan se. Her kan man legge inn resultatene til kampen
  function hentkamper(snapshotKamper) {
    let kampListe = document.querySelector("#kampListe");
    let kamp = snapshotKamper.val();
    let kampID = kamp.kampNR;
    let lagref1 = database.ref("lag/" + kamp.lag1);
    let lagref2 = database.ref("lag/" + kamp.lag2);
    kampListe.innerHTML += `
    <div class="kamp" id=${kampID}>
    <h2>${kampID}</h2>
      <div id=${kampID + "L1"}></div>
      <div>
        <h2>Vinner</h2>
      </div>
      <div id=${kampID + "L2"}></div>
      <form id=${kampID + "form"} onsubmit="registrerGjett(event,${kampID},${kampID + "form1"},${kampID + "form2"}, ${kampID + "vinner"})">
        <div><select id=${kampID + "form1"}>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select></div>
        <div><select id=${kampID + "vinner"}>
          <option>Vinner</option>
        </select></div>
        <div><select id=${kampID + "form2"}>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select></div>
        <div></div>
        <button type="submit">Send inn</button>
        <div></div>
      </form>
    </div>
    `;
    admindel.innerHTML += `
    <div class="kamp" id=${kampID+ "a"}>
    <h2>${kampID}</h2>
      <div id=${kampID + "L1" + "a"}></div>
      <div>
        <h2>Vinner</h2>
      </div>
      <div id=${kampID+ "L2" + "a"}></div>
      <form id=${kampID + "form" + "a"} onsubmit="registrerResultat(event,${kampID},${kampID + "form1"+"a"},${kampID + "form2"+"a"}, ${kampID + "vinner"+"a"})">
        <div><select id=${kampID + "form1" + "a"}>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select></div>
        <div><select id=${kampID + "vinner" + "a"}>
          <option>Vinner</option>
        </select></div>
        <div><select id=${kampID + "form2" + "a"}>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select></div>
        <div></div>
        <button type="submit">Send inn</button>
        <div></div>
      </form>
    </div>`;
    let kampVinnerValg = document.querySelector("#" + kampID + "vinner");
    let kampVinnerValgadmin = document.querySelector("#"+kampID+"vinner"+"a");
    lagref1.once("value", function (snapshotLag1) {
      let lag1Key = snapshotLag1.key;
      let lag1 = snapshotLag1.val();
      let lag1display = document.querySelector("#" + kampID +"L1");
      let lag1displayadmin = document.querySelector("#" + kampID+"L1" + "a");
      lag1display.innerHTML += `
      <img src=${lag1.logo}>
      <h3>${lag1.navn}</h3>
      `;
      kampVinnerValg.innerHTML += `<option value=${lag1Key}>${lag1.navn}</option>`;
      lag1displayadmin.innerHTML += `
      <img src=${lag1.logo}>
      <h3>${lag1.navn}</h3>
      `;
      kampVinnerValgadmin.innerHTML += `<option value=${lag1Key}>${lag1.navn}</option>`;
    });
    lagref2.once("value", function (snapshotLag2) {
      let lag2Key = snapshotLag2.key;
      let lag2 = snapshotLag2.val();
      let lag2display = document.querySelector("#" + kampID + "L2");
      lag2display.innerHTML += `
      <img src=${lag2.logo}>
      <h3>${lag2.navn}</h3>
      `;
      kampVinnerValg.innerHTML += `<option value=${lag2Key}>${lag2.navn}</option>`;
      let lag2displayadmin = document.querySelector("#" + kampID + "L2" + "a");
      lag2displayadmin.innerHTML += `
      <img src=${lag2.logo}>
      <h3>${lag2.navn}</h3>
      `;
      kampVinnerValgadmin.innerHTML += `<option value=${lag2Key}>${lag2.navn}</option>`;
    });
  }
  //Lar brukere registrere gjettne sine
  function registrerGjett(event, kampGjett, lag1stilling, lag2stilling, vinner) {
    event.preventDefault();
    let gjettKey = LoggetPåBrukerKey+kampGjett.id;
    console.log(LoggetPåBruker.brukernavn);
    let gjettData = {
      "vinner": vinner.value,
      "lag1stilling":lag1stilling.value,
      "lag2stilling":lag2stilling.value,
      "bruker":LoggetPåBrukerKey,
      "kamp":kampGjett.id,
      "poeng":0
    };
    let Gjett = gjett.child(gjettKey);
    Gjett.set(gjettData);
  }
  //Lar admin registrere resultatet til en kamp etter at den er ferdig
  function registrerResultat(event, kampResultat, lag1stillig, lag2stilling, vinner){
    event.preventDefault();
    let resultatKey = kampResultat.id;
    let resultatData = {
      "vinner": vinner.value,
      "lag1resultat": lag1stillig.value,
      "lag2resultat": lag2stilling.value
    };
    let resultat = kamper.child(resultatKey);
    resultat.update(resultatData);
  }

  //Ser på alle gjettene, sammenlikner dem med resultatet i den relevante kampen og gir poeng
  function hentGjett (snapshotGjett){
    let gjett = snapshotGjett.val();
    let gjettKey = snapshotGjett.key;
    let brukerRef = database.ref("brukere/"+gjett.bruker);
    let kampRef = database.ref("kamper/"+gjett.kamp);
    let poengFått=0;
    brukerRef.once("value", function (snapshotBruker) {
      brukerObjKey = snapshotBruker.key;
      brukerObj = snapshotBruker.val();
      console.log(brukerObj.brukernavn)
    });
    kampRef.once("value", function (snapshotKamp) {
      kampObj = snapshotKamp.val();
    });
    if (gjett.vinner == kampObj.vinner){
      brukerObj.poeng--;
    }
    if (gjett.lag1stilling == kampObj.lag1resultat && gjett.lag2stilling == kampObj.lag2resultat){
      brukerObj.poeng--;
    }
    let brukerData = {
      "poeng":brukerObj.poeng
    };
    let bruker = brukere.child(brukerObjKey);
    bruker.update(brukerData);
  }
  //De to neste funksjonene regner ut poengene til hver spiller. Poengene på bli satt til 0 hver gang for at man ikke skal få mer poeng hver gang koden kjøres
  function regnUtPoeng(){
    brukere.on("child_added", resetPoeng);
    gjett.on("child_added", hentGjett);
  }
  function resetPoeng(snapshotreset) {
    let brukerkey = snapshotreset.key;
    let brukerData = {
      "poeng":0
    };
    let bruker = brukere.child(brukerkey);
    bruker.update(brukerData);
  }
  lag.on("child_added", hentLag);
  kamper.on("child_added", hentkamper);
  brukere
    .orderByChild("poeng")
    .on("child_added", Leaderboard);
</script>
</body>
</html>
